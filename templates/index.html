<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Job Application Tracker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .dashboard-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            padding: 1rem 2rem;
            margin: -2rem -2rem 2rem -2rem;
            border-radius: 12px 12px 0 0;
            box-shadow: var(--shadow-sm);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .greeting {
            display: flex;
            flex-direction: column;
        }

        .greeting h2 {
            font-size: 1.1rem;
            margin: 0;
            color: var(--text-primary);
        }

        .greeting p {
            font-size: 0.85rem;
            margin: 0;
            color: var(--text-secondary);
        }

        .nav-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .btn-secondary {
            background-color: var(--background);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .export-dropdown {
            position: relative;
        }

        .export-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 150px;
            display: none;
            z-index: 100;
        }

        .export-menu.show {
            display: block;
        }

        .export-menu a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .export-menu a:hover {
            background-color: var(--background);
        }

        .export-menu a:first-child {
            border-radius: 8px 8px 0 0;
        }

        .export-menu a:last-child {
            border-radius: 0 0 8px 8px;
        }

        .quick-stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-stat {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
        }

        .quick-stat h4 {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .quick-stat .number {
            font-size: 2rem;
            font-weight: 700;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-header h2 {
            margin: 0;
        }

        .toggle-form-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-collapsed {
            display: none;
        }

        @media (max-width: 768px) {
            .dashboard-nav {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .nav-actions {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <!-- Dark Mode Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">
        <svg id="themeIcon" viewBox="0 0 24 24">
            <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
    </button>

    <div class="container">
        <div class="dashboard-nav">
            <div class="user-info">
                <div class="user-avatar">
                    {{ current_user.first_name[0] }}{{ current_user.last_name[0] }}
                </div>
                <div class="greeting">
                    <h2>Welcome back, {{ current_user.first_name }}! ðŸ‘‹</h2>
                    <p>Track and manage your job applications</p>
                </div>
            </div>
            <div class="nav-actions">
                <div class="export-dropdown">
                    <button class="btn btn-secondary" onclick="toggleExportMenu()" id="exportBtn">
                        Export â–¼
                    </button>
                    <div class="export-menu" id="exportMenu">
                        <a href="{{ url_for('export_csv') }}">ðŸ“„ Export as CSV</a>
                        <a href="{{ url_for('export_pdf') }}">ðŸ“‘ Export as PDF</a>
                    </div>
                </div>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary" style="text-decoration: none;">Logout</a>
            </div>
        </div>

        <div class="quick-stats-row">
            <div class="quick-stat">
                <h4>This Week</h4>
                <div class="number" id="weekApps">0</div>
            </div>
            <div class="quick-stat" style="background: linear-gradient(135deg, #10b981, #059669);">
                <h4>Response Rate</h4>
                <div class="number" id="responseRate">0%</div>
            </div>
            <div class="quick-stat" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                <h4>Active Applications</h4>
                <div class="number" id="activeApps">0</div>
            </div>
        </div>

        <section class="add-application" id="addApplicationSection">
            <div class="section-header">
                <h2>Add New Application</h2>
                <button class="btn btn-secondary toggle-form-btn" onclick="toggleForm()">
                    <span id="toggleIcon">âˆ’</span> <span id="toggleText">Collapse</span>
                </button>
            </div>
            <form id="applicationForm" class="auth-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="company">Company Name *</label>
                        <input type="text" id="company" name="company" required>
                    </div>
                    <div class="form-group">
                        <label for="position">Position *</label>
                        <input type="text" id="position" name="position" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="dateApplied">Date Applied *</label>
                        <input type="date" id="dateApplied" name="dateApplied" required>
                    </div>
                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" name="status" required>
                            <option value="">Select Status</option>
                            <option value="Applied">Applied</option>
                            <option value="Phone Screen">Phone Screen</option>
                            <option value="Interview Scheduled">Interview Scheduled</option>
                            <option value="Interviewed">Interviewed</option>
                            <option value="Offer">Offer</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Withdrawn">Withdrawn</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" placeholder="e.g., Remote, New York, NY">
                    </div>
                    <div class="form-group">
                        <label for="salary">Salary Range</label>
                        <input type="text" id="salary" name="salary" placeholder="e.g., $80k - $100k">
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="Add any additional notes..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary">
                    <span id="submitBtnText">Add Application</span>
                </button>
            </form>
        </section>

        <section class="stats">
            <div class="stat-card">
                <h3>Total Applications</h3>
                <p class="stat-number" id="totalApps">0</p>
            </div>
            <div class="stat-card">
                <h3>Interviews</h3>
                <p class="stat-number" id="totalInterviews">0</p>
            </div>
            <div class="stat-card">
                <h3>Offers</h3>
                <p class="stat-number" id="totalOffers">0</p>
            </div>
            <div class="stat-card">
                <h3>Pending</h3>
                <p class="stat-number" id="totalPending">0</p>
            </div>
        </section>

        <section class="applications-list">
            <div class="list-header">
                <h2>Your Applications</h2>
                <div class="filters">
                    <select id="filterStatus">
                        <option value="all">All Status</option>
                        <option value="Applied">Applied</option>
                        <option value="Phone Screen">Phone Screen</option>
                        <option value="Interview Scheduled">Interview Scheduled</option>
                        <option value="Interviewed">Interviewed</option>
                        <option value="Offer">Offer</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Withdrawn">Withdrawn</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="Search companies or positions...">
                </div>
            </div>

            <div id="applicationsList" class="applications-container">
                <div class="empty-state">
                    <p>Loading applications...</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        let applications = [];
        let editingId = null;

        // Dark mode functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (theme === 'dark') {
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>';
            } else {
                icon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>';
            }
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);

        // Export menu functionality
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('show');
        }

        // Close export menu when clicking outside
        document.addEventListener('click', function(e) {
            const exportBtn = document.getElementById('exportBtn');
            const exportMenu = document.getElementById('exportMenu');
            if (!exportBtn.contains(e.target) && !exportMenu.contains(e.target)) {
                exportMenu.classList.remove('show');
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            loadApplications();
            setDefaultDate();
        });

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateApplied').value = today;
        }

        function toggleForm() {
            const form = document.getElementById('applicationForm');
            const icon = document.getElementById('toggleIcon');
            const text = document.getElementById('toggleText');
            
            if (form.classList.contains('form-collapsed')) {
                form.classList.remove('form-collapsed');
                icon.textContent = 'âˆ’';
                text.textContent = 'Collapse';
            } else {
                form.classList.add('form-collapsed');
                icon.textContent = '+';
                text.textContent = 'Expand';
            }
        }

        async function loadApplications() {
            try {
                const response = await fetch('/api/applications');
                if (response.ok) {
                    applications = await response.json();
                    updateStats();
                    updateQuickStats();
                    displayApplications();
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                showNotification('Error loading applications', 'error');
            }
        }

        document.getElementById('applicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                company: document.getElementById('company').value,
                position: document.getElementById('position').value,
                dateApplied: document.getElementById('dateApplied').value,
                status: document.getElementById('status').value,
                location: document.getElementById('location').value,
                salary: document.getElementById('salary').value,
                notes: document.getElementById('notes').value
            };

            try {
                let response;
                if (editingId) {
                    response = await fetch(`/api/applications/${editingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                    editingId = null;
                    document.getElementById('submitBtnText').textContent = 'Add Application';
                } else {
                    response = await fetch('/api/applications', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                }

                if (response.ok) {
                    await loadApplications();
                    this.reset();
                    setDefaultDate();
                    showNotification('Application saved successfully!');
                } else {
                    showNotification('Error saving application', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error saving application', 'error');
            }
        });

        document.getElementById('filterStatus').addEventListener('change', displayApplications);
        document.getElementById('searchInput').addEventListener('input', displayApplications);

        function displayApplications() {
            const filterStatus = document.getElementById('filterStatus').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = applications.filter(app => {
                const matchesStatus = filterStatus === 'all' || app.status === filterStatus;
                const matchesSearch = app.company.toLowerCase().includes(searchTerm) || 
                                     app.position.toLowerCase().includes(searchTerm);
                return matchesStatus && matchesSearch;
            });

            const container = document.getElementById('applicationsList');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No applications found. Start by adding your first application!</p></div>';
                return;
            }

            container.innerHTML = filtered.map(app => `
                <div class="application-card" data-id="${app.id}">
                    <div class="card-header">
                        <div>
                            <h3>${app.company}</h3>
                            <p class="position">${app.position}</p>
                        </div>
                        <span class="status-badge status-${app.status.toLowerCase().replace(/\s+/g, '-')}">${app.status}</span>
                    </div>
                    <div class="card-body">
                        <div class="info-row">
                            <span class="label">Date Applied:</span>
                            <span>${formatDate(app.dateApplied)}</span>
                        </div>
                        ${app.location ? `
                        <div class="info-row">
                            <span class="label">Location:</span>
                            <span>${app.location}</span>
                        </div>
                        ` : ''}
                        ${app.salary ? `
                        <div class="info-row">
                            <span class="label">Salary:</span>
                            <span>${app.salary}</span>
                        </div>
                        ` : ''}
                        ${app.notes ? `
                        <div class="info-row notes">
                            <span class="label">Notes:</span>
                            <span>${app.notes}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="card-actions">
                        <button class="btn-icon" onclick="editApplication(${app.id})" title="Edit">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11.333 2.00004C11.5081 1.82494 11.716 1.68605 11.9447 1.59129C12.1735 1.49653 12.4187 1.44775 12.6663 1.44775C12.914 1.44775 13.1592 1.49653 13.3879 1.59129C13.6167 1.68605 13.8246 1.82494 13.9997 2.00004C14.1748 2.17513 14.3137 2.383 14.4084 2.61178C14.5032 2.84055 14.552 3.08575 14.552 3.33337C14.552 3.58099 14.5032 3.82619 14.4084 4.05497C14.3137 4.28374 14.1748 4.49161 13.9997 4.66671L5.33301 13.3334L1.33301 14.6667L2.66634 10.6667L11.333 2.00004Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <button class="btn-icon btn-danger" onclick="deleteApplication(${app.id})" title="Delete">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M2 4H3.33333H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M5.33301 4.00004V2.66671C5.33301 2.31309 5.47348 1.97395 5.72353 1.7239C5.97358 1.47385 6.31272 1.33337 6.66634 1.33337H9.33301C9.68663 1.33337 10.0258 1.47385 10.2758 1.7239C10.5259 1.97395 10.6663 2.31309 10.6663 2.66671V4.00004M12.6663 4.00004V13.3334C12.6663 13.687 12.5259 14.0261 12.2758 14.2762C12.0258 14.5262 11.6866 14.6667 11.333 14.6667H4.66634C4.31272 14.6667 3.97358 14.5262 3.72353 14.2762C3.47348 14.0261 3.33301 13.687 3.33301 13.3334V4.00004H12.6663Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalApps').textContent = applications.length;
            
            const interviews = applications.filter(app => 
                ['Phone Screen', 'Interview Scheduled', 'Interviewed'].includes(app.status)
            ).length;
            document.getElementById('totalInterviews').textContent = interviews;
            
            const offers = applications.filter(app => app.status === 'Offer').length;
            document.getElementById('totalOffers').textContent = offers;
            
            const pending = applications.filter(app => 
                ['Applied', 'Phone Screen', 'Interview Scheduled'].includes(app.status)
            ).length;
            document.getElementById('totalPending').textContent = pending;
        }

        function updateQuickStats() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const weekApps = applications.filter(app => {
                const appDate = new Date(app.dateApplied);
                return appDate >= oneWeekAgo;
            }).length;
            document.getElementById('weekApps').textContent = weekApps;

            const responses = applications.filter(app => 
                ['Phone Screen', 'Interview Scheduled', 'Interviewed', 'Offer'].includes(app.status)
            ).length;
            const rate = applications.length > 0 ? Math.round((responses / applications.length) * 100) : 0;
            document.getElementById('responseRate').textContent = rate + '%';

            const active = applications.filter(app => 
                !['Rejected', 'Withdrawn'].includes(app.status)
            ).length;
            document.getElementById('activeApps').textContent = active;
        }

        async function deleteApplication(id) {
            if (confirm('Are you sure you want to delete this application?')) {
                try {
                    const response = await fetch(`/api/applications/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        await loadApplications();
                        showNotification('Application deleted successfully!');
                    } else {
                        showNotification('Error deleting application', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('Error deleting application', 'error');
                }
            }
        }

        function editApplication(id) {
            const app = applications.find(a => a.id === id);
            if (app) {
                document.getElementById('company').value = app.company;
                document.getElementById('position').value = app.position;
                document.getElementById('dateApplied').value = app.dateApplied;
                document.getElementById('status').value = app.status;
                document.getElementById('location').value = app.location || '';
                document.getElementById('salary').value = app.salary || '';
                document.getElementById('notes').value = app.notes || '';
                
                editingId = id;
                document.getElementById('submitBtnText').textContent = 'Update Application';
                
                const form = document.getElementById('applicationForm');
                if (form.classList.contains('form-collapsed')) {
                    toggleForm();
                }
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            if (type === 'error') {
                notification.style.backgroundColor = 'var(--danger-color)';
            }
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>